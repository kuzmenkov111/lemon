---
title: "Working with legends"
author: "Stefan McKinnon Edwards <sme@iysik.com>"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
    fig_caption: yes
vignette: >
  %\VignetteIndexEntry{Capping axis lines}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup,include=FALSE}
library(knitr)

knitr::opts_chunk$set(fig.height=4, fig.width=6)
```

## Legend functions

* Extract legend: `g_legend`
* Combine multiple plots, but use only _one_ legend: `grid_arrange_shared_legend`
* Reposition legend onto the actual plot: `reposition_legend`

## Reposition legend onto plotting panel

`ggplot2` by default places the legend in the margin of the entire plot.
This is in many instances a nice solution.
If this is not desired, `theme(legend.position)` can be used to place the legend
in relative measures on the entire plot:

```{r}
library(ggplot2)
dsamp <- diamonds[sample(nrow(diamonds), 1000), ]
(d <- ggplot(dsamp, aes(carat, price)) +
  geom_point(aes(colour = clarity)) +
  theme(legend.position = c(0.1, 0.7))
)
```

This is however prone to badly positioning, if e.g. the plot is resized:

```{r echo=FALSE,fig.height=3, fig.width=3}
d
```

With our function, we can specify exactly how we want it in the plotting area:
```{r reposition_legend}
library(lemon)
reposition_legend(d, 'top left')
```

And it stays there.
```{r reposition_legend_small,eval=FALSE,fig.height=2, fig.width=2}
reposition_legend(d, 'top left')
```

### Placing the legend in facets

The above demonstration finds the panel named `panel`. This is default.
If using facetting, the panels are typically named `panel-{column}-{row}`.
Look at the column `name` in the following output.

```{r}
d2 <- d + facet_grid(.~cut)
ggplot_gtable(ggplot_build(d2))
```

So to place the legend in a specific panel, give its name:

```{r reposition_legend_facet1}
reposition_legend(d2, 'top left', panel = 'panel-3-1')
```

Likewise for `facet_wrap`. Incidentally, empty panels are also named here:

```{r reposition_legend_facet2}
reposition_legend(d + facet_wrap(~cut, ncol=3), 'top left', panel='panel-3-2')
```

Modifying the legend is done via usual routines of ggplot2:
```{r reposition_legend_facet3}
d3 <- d + facet_wrap(~cut, ncol=3) + scale_color_discrete(guide=guide_legend(ncol=3))
reposition_legend(d3, 'center', panel='panel-3-2')
```


## Shared legend across multiple plot

The function `grid_arrange_shared_legend` extracts the legend from its first
argument, combines the plots with the legend hidden using `arrangeGrob`, and
finally appends the legend to one of the sides. 
It even updates the plot's theme to orientate the legend correctly.

```{r}
dsamp <- diamonds[sample(nrow(diamonds), 1000), ]
p1 <- qplot(carat, price, data = dsamp, colour = clarity)
p2 <- qplot(cut, price, data = dsamp, colour = clarity)
p3 <- qplot(color, price, data = dsamp, colour = clarity)
p4 <- qplot(depth, price, data = dsamp, colour = clarity)
grid_arrange_shared_legend(p1, p2, p3, p4, ncol = 2, nrow = 2)
grid_arrange_shared_legend(p1, p2, p3, p4, ncol = 2, nrow = 2, position='right')
grid_arrange_shared_legend(p1, p2, p3, p4, ncol = 2, nrow = 2, position='bottom')

```

## To do:

* Demonstrate shared_legend vs. placing legend on "empty" cell.


## Acknowledgements

`g_legend` can be found in few variations across a multitude of
[Stack Overflow](http://www.stackoverflow.com) answers.

`grid_arrange_shared_legend` was originally proposed by 
[Shaun Jackman](http://rpubs.com/sjackman) [original code](http://rpubs.com/sjackman/grid_arrange_shared_legend)
which was furhter refined by `baptiste` at 
[ggplot2's wiki](https://github.com/tidyverse/ggplot2/wiki/Share-a-legend-between-two-ggplot2-graphs).
It has been further modified here.

`reposition_legend` was coded by [Stefan McKinnon Edwards](http://www.iysik.com/)/
