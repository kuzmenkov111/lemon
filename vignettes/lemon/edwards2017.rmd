---
title: \pkg{lemon} -- Freshing up your ggplots
author:
  - name: Stefan McKinnon Edwards
    affiliation: The Roslin Insititute, University of Edinburgh
    address:
    - Easter Bush
    - Midlothian
    - EH25 9RG
    - Scotland, UK
    email:  sme@iysik.com
    orcid: 0000-0002-4628-8148
abstract: >
  An abstract of less than 150 words.
preamble: >
  % Any extra latex you need in the preamble
  \usepackage{caption}
  \newcommand{\gtable}{\code{'gtable'}}
  \newcommand{\ggplot}{\code{'ggplot'}}
  \newcommand{\rr}{\raggedright}  %% for table
output: 
  rticles::rjournal_article:
    md_extensions: +latex_macros-tex_math_single_backslash
---


```{r setup,include=FALSE}
library(knitr)
library(ggplot2)
library(lemon)

knitr::opts_knit$set(out.format='latex')
knitr::opts_chunk$set(fig.width=5.5, fig.height=5.5/4*2.5, fig.path='edwards2017-',
                      cache=TRUE, autodep = TRUE, cache.path = 'cache/')
```

\section{Introduction}

The \CRANpkg{ggplot2} package \citep{ggplot2009,ggplot2016} is hugely popular. 
Since version 2.0, it has featured an official extension mechanism \citep{ggproto} 
that has 
spawned a number of packages that extends the capabilities of ggplot2.
At the time of writing, \url{ggplot2-exts.org} features 29 packages, 
ranging from themes of popular sources (\CRANpkg{ggthemes}, \citealt{ggthemes}),
to visualisation of graphs (\CRANpkg{ggraphs}, \citealt{ggraph}).

We are adding another package to the list.

Our motivation for this package was to provide *plot polishing* functions.
Polshing the final plot in preparation for submission can often be acheived
by subtly changing the plot's \code{theme}.
Sometimes it is however necessary to modify the drawn picture rather than the
description of the plot. 
When a \code{ggplot} plot is drawn, it is first converted to a collection
of \code{'grobs'} (portmanteau for `graphical objects') contained in a 
\code{'gtable'} object (`grob table' or 
`graphical table').
The grobs are known from the \CRANpkg{grid} package \citep{Murrell2005,Murrell2011}
and the gtable from the \CRANpkg{gtable} package \citep{gtable}.

The \pkg{lemon} package supplies functions that allows us to polish the final plot,
either by modifying the gtable object 
(e.g.\ \code{reposition\_legend}, figure \ref{fig:reposition_legend}) 
or by modifying how the gtable object is created when drawing axes 
(e.g.\ \code{capped\_horisontal} or \code{brackets\_vertical}, figure \ref{fig:brackets}).


This paper therefore gives a brief introduction to grob and gtable objects.
\citet{Zhou2010} has a more general introduction to grobs, 
that also includes the \dfn{viewports}.
Baptiste Augui\'{e}, author of \CRANpkg{gridExtra} \citep{gridExtra},
has a guide on gtable objects at
https://github.com/baptiste/gridextra/wiki/gtable.
We will however focus this introduction on the gtable object that is 
returned from ggplot.

After the introduction some of the \pkg{lemon} package's functionality is
demonstrated. A summary of the functions are supplied in table \ref{tab:functions}.

\begin{table}
  \caption{Summary of functions supplied by \pkg{lemon}.}
  \label{tab:functions}

  \begin{tabular}{p{4.5cm}p{6cm}p{3.5cm}}  % page width is 14cm
    \toprule
      Function  & Description & Returns \\
    \midrule
      \code{g\_legend} & \rr Extracts the \samp{guide-box} component from a plot. & \code{'gtable'} \\
      \code{reposition\_legend} & \rr 
        Repositions the \samp{guide-box} onto e.g.\ the main graph. 
        Accepts both \code{'ggplot'} and \code{'gtable'} objects.             & \code{'gtable'} \\
      \code{grid\_arrange\_shared\_legend} & \rr 
        Like \code{grid::grid.arrange}, but extracts legend from first argument
        and re-places it onto a margin.                                       & \code{'gtable'} \\
    \midrule
      \code{coord\_flex\_*}, \code{coord\_capped\_*} & \rr 
        Sets a Cartesian coordinate system for \code{'ggplot'} objects, 
        but accepts functions for drawing the axes.                           & Object inheriting from \code{'Coord'} class. \\
      \code{capped\_horisontal}, \code{capped\_horizontal}, \code{capped\_vertical} & \rr 
        Functions for drawing the axes. Can be supplied to the 
        \code{coord\_flex\_*} and \code{coord\_capped\_*} functions.        & Function \\
      \code{brackets\_horisontal}, \code{brackets\_horizontal}, \code{brackets\_vertical} & \rr 
        As above.                                                             & Function \\
    \midrule
      \code{facet\_rep\_grid}, \code{facet\_rep\_wrap} & \rr 
        As \CRANpkg{ggplot2}'s \code{facet\_grid} and \code{facet\_wrap}, but 
        draws \emph{all} axes and optionally tick labels.                     & Object inheriting from \code{'Facet'} class. \\
    \bottomrule
  \end{tabular}
\end{table}







\section{A brief introduction to gtable}

We assume the reader is familiar with \CRANpkg{ggplot2};
else see e.g. \citet{ggplot2016}.
In short, it differs from R's native plotting functions in that it uses 
a 'grammar of graphics' to
*describe* the visualisation we want, rather than instructions of which lines
to draw where.

The \code{'gtable'} object (\CRANpkg{gtable}, \citealt{gtable})
has its introduction when a ggplot object is to be drawn on a device. 
This causes ggplot2 to go through
the motions of training the object's scales on the data and doing its
magic on translating the grammar of graphics into instructions of which 
text, lines, points, and polygons to draw where.

These instructions are described using \code{'grobs'} (\CRANpkg{grid}, \citealt{Murrell2005,Murrell2011}). 
At their simplests, they describe the coordinates where to draw a line of a point
together with the descriptions of line style, size, colours, and font.
The coordinates are usually relative to their frame of reference (i.e.\ the \dfn{viewport}),
but can also be specified in physical measures such as centimetres and inches
(see \code{?grid::unit}).

Finally, a grob can itself be a collection of grobs.
Not only does this allow for organising the grobs in a hierarchical structure,
but the grobs' viewport may be defined relative to the grobs' parents' viewport.
The enables the user to create detailed drawings by specifying composites that 
can be positioned relative to each other, 
and not just relative to the entire canvas.

The \code{'gtable'} object is also a collection of grobs,
but with the added attributes of arranging the its collection grobs
(and grob collections) onto a table-like layout of columns and rows.
This eases the alignment of different components, such as an axis with the plot.

To get us started, we create a simple scatter plot using ggplot2 and 
then convert it to a \gtable object:

```{r}
library(ggplot2)
p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + labs(title='A scatter plot')
g <- ggplotGrob(p)
```

The first object, \code{p}, is a \ggplot object, and the second object, \code{g}, 
a \gtable object. 
Calling to print the objects, implicitly by calling the object in an interactive session
\R or directly with \code{print}, we obtain the output given in figure 
\ref{fig:p_object} for the \ggplot object, and figure \ref{fig:g_object} for the \gtable object.
To drawn the \gtable object, use \code{grid::grid.draw}.

```{r p_object}
print(p)
```
\captionof{figure}{Printing the ggplot object.}
\label{fig:p_object}

```{r g_object}
print(g)
```
  \captionof{figure}{Printing the gtable object.}
  \label{fig:g_object}



The \gtable object is of a completely different nature than the 
\ggplot object.
The \ggplot object contains the input data and descriptions of the mappings between variables, geoms, and 
scales,
the \gtable object contains the instructions for drawing the plot.
\strong{NB!} Once a \ggplot object has been converted to a \gtable object, 
it cannot be converted back again, nor is it possible to add new geoms or scales,
nor change the plot's theme.
We can however add grobs or modify the instructions of the \gtable object.




\subsection{The gtable object}

A \gtable is a hierarchical collection of grob and gtable objects
that arranges plot's features onto a table-like layout of columns and rows.
The plot's features are the main graph, axes, legend, etc.
The most important components of a \gtable object are 
the \samp{layout} data frame and the \samp{grobs} list that positions and contain the 
plot's features.
These two are combined in the listing printed in figure \ref{fig:g_object}.
In addition to these, the \samp{widths} and \samp{heights} unit lists describe the 
column widths and row heights.
This grid-structure is displayed figure \ref{fig:gtable_show_names}, 
superimposed on the plot.

```{r gtable_show_names,echo=FALSE,}
library(lemon)
library(gtable)
library(grid)
s <- gtable_show_grill(p)
grid.draw(gtable_show_names(s, plot=FALSE, rect.gp=gpar(fill='white', col='white', alpha=1/4)))
```
  \captionof{figure}{
    Overlaying plot in figure \ref{fig:p_object} with the layout names and grill of the \gtable object.
    Figure produced by \code{gtable\_show\_names} and \code{gtable\_show\_grill}.}
  \label{fig:gtable_show_names}
  
The main feature of interest is \code{panel}, which contains the actual graph.
A seen on figure \ref{fig:g_object}, \code{panel} occurs in the 
`r scales::ordinal(which(g$layout$name == 'panel'))` row, 
and thus `r scales::ordinal(which(g$layout$name == 'panel'))` grob in the grob list.
The three first columns in figure \ref{fig:g_object} are compiled from 
the \code{layout} data frame and is for the panel,


```{r render=lemon_print,format='latex'}
subset(g$layout, name == 'panel')
```
\begin{verbatim}
#> t l b r z clip  name
#> 5 6 4 6 4 1   on panel
\end{verbatim}

A grob can be drawn across multiple cells, covering both multiple rows and / or
multiple rows.
This span is specified by the top-left cell and bottom-right cell, 
corrosponding to the \code{t}, \code{l}, \code{b}, and \code{r} coordinates above.
Grobs can also drawn on top of each other, starting with lowest z-index, as given 
by the \code{z} column.
When 'clipping' is enabled, by setting \code{clip} to \code{'on'}, 
anything drawn outside the spanned cells is hidden.
The \code{name} column allows us to locate the grobs for futher manipulation.


We mention shortly here, that a grob in this context can be a simple grob primitive 
such as a rectangle (see the background) or a \code{'zeroGrob'} (a blank placeholder),
or a collection of grobs such as the panel and axes (\code{'absoluteGrob'} and \code{'titleGrob'}
are both specialised classes of grid's \code{'gTree'}). 

For \code{panel}, the grob too is a collection of grobs, in the form of a \code{gTree}
with a list of children grobs:

```{r}
str(g$grobs[[which(g$layout$name == 'panel')]], max.level=1)
```
\begin{verbatim}
#> List of 5
#>  $ name         : chr "panel-1.gTree.225"
#>  $ gp           : NULL
#>  $ vp           : NULL
#>  $ children     :List of 5
#>   ..- attr(*, "class")= chr "gList"
#>  $ childrenOrder: chr [1:5] "grill.gTree.223" "NULL" "geom_point.points.210" "NULL" ...
#>  - attr(*, "class")= chr [1:3] "gTree" "grob" "gDesc"
\end{verbatim}


Although the order of the layout data frame and grobs list are 
intrinsically linked, they are not enforced. 
The layout data frame can be accessed via \code{g\$layout} and the grobs list via
\code{g\$grobs}, and they can be manipulated separately as you 
normally would data frames and lists, respectively. 


\subsection{Widths and heights}
The gtable is also described by the heights and widths of rows and columns. 
These two components are each a 'unit.list' with a component for each row or 
column.
A quick glance at the widths of \code{g} tells us a lot:

```{r}
g$widths
```

These can be compared to the columns of figure \ref{fig:gtable_show_names};
the first and last are the plot's margins, given with \code{theme(plot.margin)}.
The second width, \code{1grobwidth}, refers to the actual width of the y-axis title
'mpg'. The third width, \code{sum(1grobwidth, 2.75pt)}, is literally the width \emph{plus}
2.75\,pt, with the width here being those of the y-axis labels. 
We will in general see grob-widths and grob-heights for text elements.
The fourth width, \code{1null}, simply expands into the available space and is here 
used to maximise the width of the actual graphing area.
The two remaining widths of 0 cm are those for a right-hand side axis, which can 
be seen on figure \ref{fig:gtable_show_names}, where their respective columns have been
expanded for us to view.

The elements of widths, and similarily for heights, are not fixed to those shown here.
Adding a legend or using facetting will change them.


\subsection{Manipulating the gtable object}

The \CRANpkg{gtable} package supplies a number of functions for manipulating
a gtable object, such as adding rows and columns (\code{gtable\_add\_rows},
\code{gtable\_add\_cols}), combining several gtable objects together as if 
they were matrices (\code{cbind}, \code{rbind}),
or adding new features to the gtable object (\code{gtable\_add\_grob}).

These functions are usually sufficient for manipulating the gtable object.
Knowing the components of the gtable object however allows us to manipulate 
the gtable object in an alternative and direct fashion.

\subsubsection{Adding or replacing features}

For adding a grob, \pkg{gtable} comes with the function 
\code{gtable\_add\_grob(x, grobs, t, l, b, r, z, clip, name)}.
This adds a new row to the \code{x\$layout} data frame with the coordinates of the
spanning cells, a \code{name} for the grob, 
and appends \code{grobs} to the \code{x\$grobs} list.

\emph{Replacing a grob} is however more tricky. 
To do so, we have to work out which index in the \code{grobs} list corresponds 
to the feature that is to be replaced. 
The following example demonstrates this and then replaces the x-axis label with 
a pink box.

```{r replace_grob}
g <- ggplotGrob(p)
i <- which(g$layout$name == 'xlab-b')
g$grobs[[i]] <- roundrectGrob(r=unit(0.5, 'snpc'), gp=gpar(fill='pink', col='black'))
grid.draw(g)
```
\captionof{figure}{Replacing the x-axis label grob with a pink square.}
\label{fig:replace_grob}


One could naturally just have added the grob with \code{gtable\_add\_grob},
placing it on top of the x-axis label. But if the grob was not filled with a 
solid colour, the label would still appear.
The example however also illustrates how to \emph{extract} a grob, if the grob
needed altering.

\emph{Row heights} and \emph{column widths} can be directly altered by changing the element
of \code{g\$heights} or \code{g\$widths}. 
Although these are specified to fit the plot's features while maximising the 
size of the panels, we can change them.
To change the width of the panel we must change the width of the column it resides in.

In the following example, we find the row in the layout data frame corresponding to the panel.
The relevant column is then specified by the \code{l} coordinate,
and we can proceed to update the widths.

```{r change_width}
g <- ggplotGrob(p)
layout <- subset(g$layout, name == 'panel')
g$widths[[layout$l]] <- unit(5, 'cm')
grid::grid.draw(g)
```
\captionof{figure}{The scatter plot with the width of the panel set to 5\,cm.}
\label{fig:change_width}

As \code{g\$widths} is a \code{unit.list} object, it requires using double square brackets
for replacing an element. This also implies changing the widths must be done
one by one, or by building a new \code{`unit.list'} object entirely.

\section{Demonstration}

The \pkg{lemon} package has functions for working with the legend (or 'guide-box') and axis lines.

\subsection{Legends}

The primary contribution here is the function \code{reposition\_legend}.
The default behaviour for \CRANpkg{ggplot2} is to place the legend in one of
the four margins of the plot.
Repositioning the legend to occur within the panel can be done by supplying 
a two-element numeric vector, specifying the position \emph{relative to the 
entire plot}, to \code{theme(legend.position)}.
This has the unfortunate effect that the legend is not positioned correctly after
changing any size of the plot (e.g.\ resizing the plot's size or changing the font sizes).

The function \code{reposition\_legend} allows us to position the relative to
any cell of the gtable. In order to do so, it forces the plot into a \gtable
object, which is always returned.

```{r reposition_legend}
reposition_legend(p %+% aes(color=cyl), position = 'top right')
```
\captionof{figure}{Repositioning the legend on to the main panel.}
\label{fig:reposition_legend}

The appearences of the legend is not modified in any way, thus modifying it is
done by the usual methods of \CRANpkg{ggplot2}. These could be
\code{theme(legend.direction)} or \code{guide\_legend(...)}.
We also highlight \code{theme(legend.box.background)} when having 
multiple legends as the component \code{theme(legend.background)} only affects
the background of each singular legend, not the area spanning all legends.

The function can also be used to add multiple legends to different locations,
as demonstrated in figure \ref{fig:multiple_legends}.

```{r multiple_legends}
x <- p %+% aes(color=cyl, size=qsec)
g <- g_legend(x)
x <- reposition_legend(x, position='bottom left', legend=g$grobs[[2]], plot=FALSE)
x <- reposition_legend(x, position='top right', legend=g$grobs[[1]], plot=FALSE)
grid.draw(x)
```
\captionof{figure}{Repositioning multiple legends to different locations.}
\label{fig:multiple_legends}

The above code also demonstrates the usage of \code{g\_legend} to extract the 
legend from a plot.
We must however emphasise that \code{g\_legend} was first proposed by
Baptiste Augui\'{e} as early as June 2012 on \CRANpkg{ggplot2}'s 
Github wiki\footnote{\url{https://github.com/tidyverse/ggplot2/wiki/Share-a-legend-between-two-ggplot2-graphs/047381b48b0f0ef51a174286a595817f01a0dfad}}.
Baptiste Augui\'{e} is the author of \CRANpkg{gridExtra} \citep{gridExtra}.
It has since propogated throughout a swarm of 
Stack Overflow answers.
For this same reason, Baptiste Augui\'{e} has been added as contributor to this
package.

Lastly, a modified version of \code{grid.arrange} with a shared legend is 
demonstrated in figure \ref{fig:brackets}.
The function \code{grid\_arrange\_shared\_legend} supplied in this package
is modified from Shaun Jackman's 
version\footnote{\url{http://rpubs.com/sjackman/grid\_arrange\_shared\_legend}} 
and Baptiste Augui\'{e} 
version\footnote{\url{https://github.com/tidyverse/ggplot2/wiki/Share-a-legend-between-two-ggplot2-graphs}}.

\subsection{Axis lines and brackets}


The second domain of functions in \pkg{lemon} is for axis lines and brackets.
We desired to alter the axis lines to be capped to tick marks, or even replaced
by brackets.

In the following example, three functions are demonstrated: 
brackets, capped axis lines, 

```{r brackets}
p <- ggplot(mpg, aes(as.factor(cyl), hwy, colour=class)) +
  geom_point(position=position_jitter(width=0.3)) +
  theme_bw()

# Demonstrate brackets
p1 <- p + coord_flex_cart(bottom=brackets_horisontal(length=unit(0.08, 'npc'))) +
  theme(panel.border = element_blank(), axis.line = element_line(),
        panel.grid.major.x = element_blank())

p <- ggplot(mpg, aes(displ, hwy, colour=class)) + geom_point() +
  theme_bw()

# Demonstrate capped axis lines
p2 <- p + coord_capped_cart(bottom='right', left='none', gap = 0.03) +
  theme(panel.border = element_blank(), axis.line = element_line(),
        panel.grid.major.x = element_blank())


# Demonstrate shared legend
grid_arrange_shared_legend(p1, p2, position='bottom')
```
\captionof{figure}{
  \emph{Left:} Displaying brackets on an axis to indicate categorical values.
  \emph{Right:} Capped axis lines, with x-axis capped at right-most tick, and
               y-axis capped by a small proportion.
}
\label{fig:brackets}

The \code{coord} functions are analogous to \CRANpkg{ggplot2}'s Cartesian Coordinate
functions (\code{coord\_cartesian}, \code{coord\_flip}, and \code{coord\_fixed}).
The \code{coord\_capped\_\*} functions are wrappers for \code{coord\_flex\_\*},
which in turn are classes inheriting from the relevant Cartesian \code{Coord} 
classes.
The difference between our \code{coord\_flex\_\*} and their super classes is 
how that ours accept user defined functions for rendering the axes
such as those returned from \code{capped\_horisontal} or \code{brackets\_horisontal}.

The appearences of the customised axis lines are taken from their corresponding
components of \code{theme} for consistency.
The bracket functions accepts arguments to change the direction of the end `ticks',
as well as the length of the bracket and the length of the end `ticks'.


The use of axis lines to be more informative of the displayed data has been
shown in \citep[p.\,130]{Tufte2001} with \dfn{range-frames}, where axis lines
are limited to the range of the displayed data.
This has been implemented in \CRANpkg{ggthemes} \citep{ggthemes} with
\code{geom\_rangeframe}.

Our capped axis lines differs from these by intending to display the valid range
the values may take. E.g.\ correlations where the value cannot exceed \textpm\,1.




\subsection{Facets with repeated axis lines}

\CRANpkg{ggplot2}'s facets avoid displaying redundant axis lines and 
labels, when the scale is identical along a row or column.
This is mostly a good idea, but as demonstrated, we have put some effort into how
the axis lines are drawn and as such, we want to have them displayed on all
facet panels.


The function \code{facet\_rep\_grid} is demonstrated in figure \ref{fig:facet_rep}.
As with the \code{coord\_flex\_\*} functions, the facets with repeated axis lines
are analogous to \CRANpkg{ggplot2}'s facet functions 
(\code{facet\_grid} and \code{facet\_wrap}), and are implemented by subclassing
the corresponding classes using the new extension mechanism that came with
\CRANpkg{ggplot2} v.\ 2.2.0.

```{r facet_rep}
d <- ggplot(diamonds, aes(carat, price)) +
  geom_point(aes(colour = clarity)) + 
  coord_capped_cart(bottom='none', left='bottom') +
  facet_grid(.~cut) + theme_bw() + 
  theme(panel.border = element_blank(), axis.line = element_line(),
        legend.position='bottom')
d + facet_rep_grid(.~cut)
```
\captionof{figure}{Faceting with axis lines repeated across all panels.}
\label{fig:facet_rep}


\section{Summary}

\subsection{Availability}

The \pkg{lemon} package is currently available on GitHub and can be installed as

\begin{verbatim}
devtools::install_github("stefanedwards/lemon")
\end{verbatim}

The package is being prepared for submission to CRAN.



\subsection{Acknowledgements}

This article was initiated with the `rticles` package \citep{rticles}.

The author, SME, was funded by the MRC (FARSPhase: a Flexible, widely Applicable, Robust, and Scalable phasing algorithm for human genetics, grant no. MR/M000370/1),
while working on this software.

\href{https://baptiste.github.io/}{Baptiste Augui\'{e}} for his work on many
functions for \CRANpkg{ggplot2} and \CRANpkg{grid} for which without, 
this package could not have been possible.


This file is only a basic article template. For full details of _The R Journal_ style and information on how to prepare your article for submission, see the [Instructions for Authors](https://journal.r-project.org/share/author-guide.pdf).

\bibliography{edwards2017}
