---
title: Lemon --- yet another ggplot2 extension package
author:
  - name: Stefan McKinnon Edwards
    affiliation: The Roslin Insititute, University of Edinburgh
    address:
    - Easter Bush
    - Midlothian
    - EH25 9RG
    - Scotland, UK
    email:  sme@iysik.com
abstract: >
  An abstract of less than 150 words.
preamble: >
  % Any extra latex you need in the preamble
output: rticles::rjournal_article
---


```{r setup,include=FALSE}
library(knitr)
library(ggplot2)

knitr::opts_chunk$set(fig.height=4, fig.width=6,
                      cache=TRUE, autodep = TRUE, cache.path = 'cache/')
```

## Introduction

The ggplot2 package \citep{ggplot2} which utilises the 'grammar of graphics' to
describe a plot is hugely popular. 
Since version 2.0, it has featured an official extension mechanism that has
spawned a number of packages that extends the capabilities of ggplot2.
At the time of writing, \url{ggplot2-exts.org} features 29 packages, 
ranging from themes of popular sources (`ggthemes`, \citealt{ggthemes}),
to visualisation of graphs (`ggraphs`, \citealt{ggraph}).

We are adding another package to the list.





### A brief introduction to gtable

We assume the reader is familiar with ggplot2 \citep{ggplot2}. 
In short, it differs from R's native plotting functions in that we use it to 
*describe* the visualisation we want, rather than instructions of which lines
to draw where.

The majority of the lemon package's functions however works on the 
graphical objects that describe what is being drawn. 
These graphic objects, or grobs \citep{Murell2005}, appear after ggplot2 has done 
its magic on translating the grammar of graphics into instructions of what to draw where.

We will only give a brief introduction to grob objects, but refer to 
e.g. \citet{Zhou2010} for a more general introduction, that also includes
the important 'viewports'.
Other authors, such as Baptiste Augui\'{e} who has made considerable contributions
to using ggplot2, has a guide on  at
https://github.com/baptiste/gridextra/wiki/gtable.
We will however focus this introduction on the gtable object returned from ggplot.


%% The ggplot object returned from calling 
%% `ggplot(data, aes(...)) + ...` only describes the mapping between variables, 
%% geoms (points, bars, etc.), and scales, and the theme.


The 'gtable' package \citep{gtable} and object has its introduction when a ggplot 
object is to be drawn on a device. 
Here, the device may be the screen, a plot window, a file, etc.
Calling to view a ggplot object, either explicitly through `print` or `plot`, 
or through any other of the multitude of functions, ggplot2 goes through
the motions of training the object's scales on the data to finally produce a 
printable object (see function `ggplot_build` in ggplot2 package).
This object is a grob table -- a gtable object -- that is drawn by the
'grid' package \citep{Murrell2005,Murrell2011} (but you as a user do not necessarily see this).

To get us started, we define a plot using ggplot2 of a simple scatter plot:

```{r}
library(ggplot2)
p <- ggplot(mtcars, aes(wt, mpg)) + geom_point() + labs(title='A scatter plot')
g <- ggplotGrob(p)
```

\begin{figure}[htbp]
  \centering
```{r p_object,echo=FALSE, fig.label='fig:p_object',fig.cap=''}
print(p)
```
  \caption{Printing a simple ggplot object.}
  \label{fig:p_object}
\end{figure}


The first object, `p`, is a ggplot object, and the second object, `g`, a gtable
object. 
Calling to print the objects, implicitly by calling the object from the command line
of R or directly with `print`, we obtain the output given in figure \ref{fig:p_object} 
for the ggplot object, and the following for the gtable object:
\begin{figure}[htbp]
  \centering
```{r g_object}
print(g)
```
  \caption{Printing the gtable object.}
  \label{fig:g_object}
\end{figure}

The gtable object is of a completely different nature than the 
ggplot object.
Where the ggplot object describes the mapping between variables, geoms, and 
scales, the gtable object positions the plot's features in a table-like structure.
Each feature of the plot, i.e. the background, an axis, or the actual graph ('panel')
are displayed on a row.

### The gtable object

A gtable object is a hierarchical collection of grob and gtable objects,
placing them in a table-like structure. 
The most important components of each gtable object are 
the `layout` data frame and the `grobs` list that position and contain the 
plot's features,
in addition to `widths` and `heights` unit lists that describe the 
column widths and row heights.
These are displayed in figure \ref{fig:gtable_show_names}, superimposed on the plot.

\begin{figure}[htbp]
  \centering
```{r gtable_show_names,echo=FALSE}
library(gtable)
library(grid)
s <- gtable_show_names(gtable_show_grill(p, plot=FALSE), plot=FALSE)
g1 <- gtable_add_cols(g, s$widths[[1]], 0)
g1 <- gtable_add_rows(g1, s$heights[[1]], 0)
g1$widths <- s$widths
g1$heights <- s$heights

grid.draw(g1)
grid.draw(s)
```
  \caption{Overlaying figure \ref{fig:p_object} with the layout names and grill, by `gtable_show_names` and `gtable_show_grill`.}
  \label{fig:gtable_show_names}
\end{figure}


The main feature of interest is `panel`, which contains the actual graph.
A seen on figure \ref{fig:g_object}, `panel` occurs in the 
`r scales::ordinal(which(g$layout$name == 'panel'))` row, 
and thus `r scales::ordinal(which(g$layout$name == 'panel'))` grob in the grob list.
The three first columns in figure \ref{fig:g_object} are compiled from 
the layout data frame, which can be accessed via `$layout`, and is for the panel

```{r}
subset(g$layout, name == 'panel')
```
with the first four columns corresponding to top, left, bottom, and right coordinate.
The grob can be drawn across multiple cells, covering both multiple rows and / or
multiple rows. 
The top-left cell is determined by the top and left coordinate (`t` and `l`), while the 
bottom-right cell is determined by the bottom and right coordinate (`b` and `r`).
Grobs are drawn on top of each other, starting with lowest z-index, as given 
by the `z` column.
Enabling 'clipping', by setting `clip` to `'on`', 
anything drawn outside the spanned cells is hidden.
The `name` column allows us to locate the grobs for futher manipulation.


We mention shortly here, that a grob in this context can be a simple grob primitive 
such as a rectangle (see the background) or a `zeroGrob` (a blank placeholder),
or a collection of grobs such as the panel and axes (`absoluteGrob` and `titleGrob`
are both specialised classes of grid's `gTree`). 

For 'panel', the grob too is a collection of grobs:
```{r}
str(g$grobs[[which(g$layout$name == 'panel')]], max.level=1)
```


Although the order of the layout data frame and grobs list are 
intrinsically linked, they are not enforced. 
The layout data frame can be accessed via `g$layout` and the grobs list via
`g$grobs`, and they can be manipulated separately as you 
normally would data frames and lists, respectively. 

### Manipulating the gtable object



### Widths and heights
The gtable is also described by the heights and widths of rows and columns. 
These two components are each a '`unit.list`' with a component for each row or 
column.
A quick glance at `g`'s widths tells us a lot:

```{r}
g$widths
```

These can be compared to the columns of (figure with gtable_show_names);
the first and last are the plot's margins, given with `theme(plot.margin)`.
The second width, `1grobwidth`, refers to the actual width of the y-axis title
'mpg'. The third width, `sum(1grobwidth, 2.75pt)`, is literally the width *plus*
2.75 pt, with the width here being those of the y-axis labels. 
We will in general see grob-widths and grob-heights for text elements.
The fourth width, `1null`, simply expands into the available space and is here 
used to maximise the width of the actual graphing area.
The two remaining widths of 0 cm are those for a right-hand side axis, which can 
be seen on the (`gtable_show_grill`), where their respective columns have been
expanded for us to view.

The elements of widths, and similarily for heights, are not fixed. 
Adding a legend or using facetting will change them.


We utilise the functions `gtable_show_grill` and `gtable_show_names` in 
succession to visualise the elements.




## Section title in sentence case

This section may contain a figure such as Figure \ref{figure:rlogo}.

\begin{figure}[htbp]
  \centering
  \includegraphics{Rlogo}
  \caption{The logo of R.}
  \label{figure:rlogo}
\end{figure}

## Another section

There will likely be several sections, perhaps including code snippets, such as:

```{r}
x <- 1:10
x
```

## Summary

## Acknowledgements

This article was initiated with the `rticles` package \citep{rticles}.


This file is only a basic article template. For full details of _The R Journal_ style and information on how to prepare your article for submission, see the [Instructions for Authors](https://journal.r-project.org/share/author-guide.pdf).
\bibliography{RJreferences}
